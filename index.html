<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –°–±–æ—Ä: Ultimate Edition</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --primary: #0ea5e9;
            --accent: #f43f5e;
            --gold: #fbbf24;
            --green: #22c55e;
            --text: #f8fafc;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; touch-action: pan-y; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            color: var(--text);
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            display: flex; justify-content: center; align-items: center;
            position: fixed;
            width: 100%;
        }

        #game-container {
            position: relative;
            width: 100%; max-width: 600px; 
            height: 100vh;
            height: 100dvh;
            background: linear-gradient(to bottom, #0b1026 0%, #2b32b2 100%);
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
            touch-action: none;
        }

        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
            touch-action: none;
        }

        /* UI LAYERS */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            pointer-events: none; 
            transition: opacity 0.3s ease, visibility 0.3s;
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }
        
        .ui-layer.hidden { 
            opacity: 0; 
            visibility: hidden; 
            z-index: -1; 
        }

        .interactive, .btn, .modal, .shop-item, .card { pointer-events: all; }

        /* LOADING SCREEN */
        #loading-screen {
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: 20px;
        }
        
        .loading-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .loading-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        
        .loading-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 10px var(--gold);
        }
        
        .loading-text {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 20px;
            min-height: 40px;
        }
        
        .story-text {
            font-size: 1rem;
            line-height: 1.6;
            color: #fff;
            text-align: left;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* TUTORIAL SCREEN */
        #tutorial-screen {
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            pointer-events: all;
            z-index: 999;
        }
        
        .tutorial-box {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 3px solid var(--primary);
        }
        
        .tutorial-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .tutorial-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .tutorial-desc {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            color: rgba(255,255,255,0.9);
        }
        
        .tutorial-step {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        /* MENU */
        #menu-screen {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            pointer-events: all;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 0 150px 0; /* –£–≤–µ–ª–∏—á–µ–Ω –Ω–∏–∂–Ω–∏–π padding –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
            -webkit-overflow-scrolling: touch;
        }
        
        .logo { 
            font-size: 2.5rem; 
            font-weight: 900; 
            color: var(--gold); 
            text-shadow: 0 0 15px var(--accent); 
            margin-bottom: 15px; 
            animation: float 3s ease-in-out infinite; 
        }
        
        .header-stats {
            display: flex; 
            gap: 15px; 
            width: 90%; 
            justify-content: center;
            background: rgba(255,255,255,0.1); 
            padding: 12px; 
            border-radius: 15px;
            margin-bottom: 15px; 
            font-weight: bold;
        }

        /* IDLE BOX */
        .idle-box {
            background: linear-gradient(45deg, #1e293b, #334155);
            width: 90%; 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .idle-info div:first-child { font-size: 0.8rem; color: #94a3b8; }
        .idle-amount { font-size: 1.4rem; color: var(--green); font-weight: bold; }

        /* TABS */
        .tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 10px; 
            background: rgba(0,0,0,0.3); 
            padding: 5px; 
            border-radius: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            background: none; 
            border: none; 
            color: #888; 
            padding: 8px 12px;
            font-weight: bold; 
            border-radius: 15px; 
            transition: 0.2s;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); 
        }

        /* CARDS GRID */
        .card-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            width: 90%; 
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.08); 
            padding: 10px; 
            border-radius: 12px;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between;
        }
        .card h3 { margin: 5px 0; font-size: 0.9rem; }
        .card .icon { font-size: 2rem; margin: 5px 0; }
        .lvl-badge { 
            font-size: 0.7rem; 
            background: #333; 
            padding: 2px 6px; 
            border-radius: 4px; 
            color: #aaa; 
        }
        
        .card.locked {
            opacity: 0.6;
            border: 2px solid #ef4444;
            position: relative;
        }
        
        .card.locked::before {
            content: 'üîí';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5rem;
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%);
            border: none; 
            padding: 15px 40px; 
            color: white;
            font-size: 1.2rem; 
            font-weight: bold; 
            border-radius: 30px;
            cursor: pointer; 
            margin: 5px;
            box-shadow: 0 4px 15px rgba(221, 36, 118, 0.4);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-small { 
            padding: 8px 16px; 
            font-size: 0.9rem; 
            background: rgba(255,255,255,0.2); 
            box-shadow: none; 
        }
        .btn.green { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            box-shadow: 0 4px 0 #15803d; 
        }
        .btn:disabled { 
            filter: grayscale(1); 
            opacity: 0.6; 
            cursor: not-allowed;
            transform: scale(1);
        }

        /* PLAY BUTTON CONTAINER - –ò–°–ü–†–ê–í–õ–ï–ù–û: FIXED –ü–û–ó–ò–¶–ò–Ø */
        .play-container {
            position: fixed; 
            bottom: 0; 
            left: 50%;
            transform: translateX(-50%);
            width: 100%; 
            max-width: 600px;
            display: flex; 
            gap: 10px;
            z-index: 100; /* –£–≤–µ–ª–∏—á–µ–Ω z-index */
            padding: 15px;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.98) 0%, rgba(15, 23, 42, 0.95) 80%, transparent 100%);
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
        .big-play-btn {
            flex: 2; 
            font-size: 1.5rem; 
            padding: 20px;
            background: linear-gradient(to right, #f59e0b, #d97706);
            box-shadow: 0 6px 0 #b45309;
        }

        /* HUD */
        #hud-screen { 
            justify-content: space-between; 
            padding: 15px; 
            pointer-events: none; 
        }
        .hud-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            width: 100%;
        }
        .hearts-container { font-size: 1.5rem; letter-spacing: 5px; }
        .score-container { 
            font-size: 2rem; 
            font-weight: 800; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
        }
        
        /* COMBO SYSTEM */
        .combo-display {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 12px;
            border: 2px solid var(--gold);
            font-size: 1.2rem;
            font-weight: bold;
            display: none;
            animation: pulse 0.5s infinite;
        }
        .combo-display.show { display: block; }
        
        /* ACTIVE POWERUPS DISPLAY */
        .powerups-display {
            position: absolute;
            top: 60px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .powerup-indicator {
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 2px solid;
            animation: pulse 1s infinite;
        }
        .powerup-indicator.shield { border-color: #3b82f6; }
        .powerup-indicator.magnet { border-color: #f59e0b; }
        .powerup-indicator.double { border-color: #22c55e; }
        .powerup-indicator.slow { border-color: #a855f7; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* WEATHER EFFECTS */
        .weather-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .snowflake, .firework-particle {
            position: absolute;
            color: white;
            font-size: 20px;
            animation: fall linear infinite;
            pointer-events: none;
        }
        
        @keyframes fall {
            to { transform: translateY(100vh); }
        }
        
        /* BOSS HP BAR */
        .boss-hp-bar {
            position: absolute; 
            top: 70px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 250px; 
            height: 20px; 
            background: #333; 
            border-radius: 10px;
            display: none; 
            overflow: hidden; 
            border: 2px solid #fff;
        }
        .boss-hp-fill { 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(90deg, #ef4444, #dc2626); 
            transition: width 0.3s; 
        }
        .boss-name {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent);
            text-shadow: 0 2px 4px black;
            display: none;
        }

        /* BOSS BATTLE MODE */
        .boss-battle-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            pointer-events: all;
        }
        .throw-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: 4px solid white;
            font-size: 2rem;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.5);
        }
        .throw-btn:active {
            transform: scale(0.9);
        }

        /* ULTIMATE BUTTON */
        .ult-bar-container {
            position: absolute; 
            bottom: 20px; 
            right: 20px; 
            width: 80px; 
            height: 80px;
            pointer-events: all;
        }
        .ult-btn {
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            border: 4px solid #fff;
            background: rgba(0,0,0,0.5); 
            color: white; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column;
            overflow: hidden; 
            position: relative; 
            font-size: 0.8rem;
            cursor: pointer;
        }
        .ult-fill {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 0%;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            transition: height 0.2s; 
            z-index: -1;
        }
        .ult-ready { 
            animation: glow 1s infinite alternate; 
            border-color: #60a5fa; 
        }
        @keyframes glow { 
            from { box-shadow: 0 0 10px #3b82f6; } 
            to { box-shadow: 0 0 25px #60a5fa; } 
        }

        /* MODALS */
        .modal {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: var(--panel-bg); 
            padding: 25px; 
            border-radius: 20px;
            width: 90%; 
            max-width: 400px; 
            text-align: center;
            border: 2px solid var(--primary);
            box-shadow: 0 0 50px rgba(14, 165, 233, 0.2);
            display: none; 
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal.open { display: block; animation: popIn 0.3s; }
        
        /* QUEST LIST */
        .quest-list, .achievement-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .quest-item, .achievement-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            position: relative;
        }
        .quest-item.completed, .achievement-item.unlocked {
            border-left-color: var(--green);
            opacity: 0.7;
        }
        .quest-progress-bar, .achievement-progress-bar {
            background: #333;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .quest-progress-fill, .achievement-progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        /* MINI GAME - –ò–°–ü–†–ê–í–õ–ï–ù–û –ö–û–õ–ï–°–û –†–£–õ–ï–¢–ö–ò */
        .minigame-container {
            width: 100%;
            margin: 20px 0;
        }
        
        .slot-machine {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .slot {
            font-size: 4rem;
            width: 80px;
            height: 100px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--gold);
        }
        
        .roulette-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 20px auto;
        }
        
        .roulette-pointer {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            z-index: 10;
        }
        
        .roulette-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            border: 5px solid var(--gold);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
            overflow: hidden;
            background: conic-gradient(
                from 0deg,
                #ef4444 0deg 60deg,
                #22c55e 60deg 120deg,
                #3b82f6 120deg 180deg,
                #fbbf24 180deg 240deg,
                #a855f7 240deg 300deg,
                #ef4444 300deg 360deg
            );
        }
        
        .roulette-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .roulette-label {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 20px;
            margin-top: -10px;
            transform-origin: left center;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px black;
        }
        
        /* LEADERBOARD */
        .leaderboard-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 40px;
        }
        
        .leaderboard-rank.first { color: #fbbf24; }
        .leaderboard-rank.second { color: #94a3b8; }
        .leaderboard-rank.third { color: #cd7f32; }
        
        /* EFFECTS */
        @keyframes float { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-10px); } 
        }
        @keyframes popIn { 
            from { transform: translate(-50%, -40%); opacity: 0; } 
            to { transform: translate(-50%, -50%); opacity: 1; } 
        }
        
        #blizzard-overlay {
            position: absolute; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%;
            background: rgba(255,255,255,0.4);
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 2s; 
            z-index: 5;
        }
        #blizzard-overlay.active { opacity: 1; }
        
        #flash-overlay {
            position: absolute; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%;
            pointer-events: none; 
            opacity: 0; 
            z-index: 20; 
            transition: opacity 0.1s;
        }
        
        .float-text {
            position: absolute; 
            font-weight: bold; 
            color: #fff;
            text-shadow: 0 2px 0 #000; 
            pointer-events: none;
            animation: floatUp 1s forwards;
            z-index: 30;
        }
        @keyframes floatUp { 
            from { transform: translateY(0) scale(1); opacity: 1; } 
            to { transform: translateY(-50px) scale(1.5); opacity: 0; } 
        }
        
        .boss-warning {
            position: absolute; 
            top: 40%; 
            width: 100%; 
            text-align: center;
            font-size: 3rem; 
            color: var(--accent); 
            font-weight: 900;
            text-shadow: 0 0 20px black; 
            opacity: 0; 
            pointer-events: none;
            z-index: 30;
        }
        .boss-warning.anim { animation: warningAnim 2s forwards; }
        @keyframes warningAnim { 
            0% { opacity:0; transform: scale(0.5); } 
            20% { opacity:1; transform: scale(1.2); } 
            80% { opacity:1; transform: scale(1); } 
            100% { opacity:0; transform: scale(1.5); } 
        }

        /* WIN NOTIFICATION */
        .win-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #22c55e, #16a34a);
            padding: 30px;
            border-radius: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            z-index: 200;
            box-shadow: 0 0 50px rgba(34, 197, 94, 0.5);
            animation: winPop 2s forwards;
            pointer-events: none;
        }
        
        @keyframes winPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            10% { transform: translate(-50%, -50%) scale(1.2); }
            20% { transform: translate(-50%, -50%) scale(1); }
            90% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="blizzard-overlay"></div>
        <div id="flash-overlay"></div>
        <div id="boss-warning-text" class="boss-warning">üëπ –ì–†–ò–ù–ß!</div>
        <div class="weather-overlay" id="weather-overlay"></div>

        <!-- LOADING SCREEN -->
        <div id="loading-screen" class="ui-layer">
            <div class="loading-content">
                <div class="loading-logo">üéÖ</div>
                <div class="loading-title">–ù–û–í–û–ì–û–î–ù–ò–ô –°–ë–û–†</div>
                
                <div id="story-container" style="display: none;">
                    <div class="story-text" id="story-text"></div>
                </div>
                
                <div class="loading-bar">
                    <div class="loading-fill" id="loading-fill"></div>
                </div>
                <div class="loading-text" id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- TUTORIAL SCREEN -->
        <div id="tutorial-screen" class="ui-layer hidden">
            <div class="tutorial-box">
                <div class="tutorial-icon" id="tutorial-icon">üéÅ</div>
                <div class="tutorial-title" id="tutorial-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
                <div class="tutorial-desc" id="tutorial-desc">–û–ø–∏—Å–∞–Ω–∏–µ...</div>
                <div class="tutorial-step" id="tutorial-step">–®–∞–≥ 1/5</div>
                <button class="btn" onclick="Tutorial.next()">–î–ê–õ–ï–ï</button>
            </div>
        </div>

        <!-- SCREEN: MENU -->
        <div id="menu-screen" class="ui-layer hidden">
            <div class="logo">üéÖ –ù–û–í–û–ì–û–î–ù–ò–ô<br>–°–ë–û–†</div>
            
            <div class="header-stats">
                <div style="color:var(--gold)">üü° <span id="menu-wallet">0</span></div>
                <div style="color:var(--accent)">‚ù§Ô∏è <span id="menu-attempts">4/4</span></div>
                <div>üèÜ <span id="menu-best">0</span></div>
            </div>

            <!-- IDLE SECTION -->
            <div class="idle-box interactive">
                <div class="idle-info">
                    <div>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≠–ª—å—Ñ–æ–≤</div>
                    <div class="idle-amount">+<span id="ui-idle-bank">0</span> üü°</div>
                    <div style="font-size:0.7rem; opacity:0.7">
                                        <span id="ui-elves-count">0</span> —ç–ª—å—Ñ–æ–≤ 
                        (<span id="ui-idle-rate">0</span>/—Å–µ–∫)
                    </div>
                </div>
                <button class="btn green btn-small" onclick="Meta.claimIdle()">–ó–ê–ë–†–ê–¢–¨</button>
            </div>

            <!-- TABS -->
            <div class="tabs interactive">
                <button class="tab-btn active" onclick="UI.switchTab('upgrades')">‚ö° –ù–∞–≤—ã–∫–∏</button>
                <button class="tab-btn" onclick="UI.switchTab('skins')">üëï –°–∫–∏–Ω—ã</button>
                <button class="tab-btn" onclick="UI.switchTab('factory')">üè≠ –ó–∞–≤–æ–¥</button>
                <button class="tab-btn" onclick="UI.switchTab('pets')">üêï –ü–∏—Ç–æ–º—Ü—ã</button>
                <button class="tab-btn" onclick="UI.switchTab('achievements')">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
            </div>

            <!-- CONTENT GRID -->
            <div id="grid-content" class="card-grid interactive">
                <!-- JS Injected content -->
            </div>

            <!-- BOTTOM PLAY BUTTON - –¢–ï–ü–ï–†–¨ FIXED -->
            <div class="play-container interactive">
                <button class="btn big-play-btn" onclick="Game.startRequest()">–ò–ì–†–ê–¢–¨</button>
                <button class="btn btn-small" style="flex:1; background: #334155;" onclick="UI.openModal('quest-modal')">üìú</button>
                <button class="btn btn-small" style="flex:1;" onclick="UI.openModal('leaderboard-modal')">üèÖ</button>
                <button class="btn btn-small" style="flex:1; background: #7c3aed;" onclick="UI.openModal('minigame-modal')">üé∞</button>
            </div>
        </div>

        <!-- SCREEN: HUD -->
        <div id="hud-screen" class="ui-layer hidden">
            <div class="hud-top">
                <div>
                    <div class="hearts-container" id="hud-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                </div>
                <div class="score-container" id="hud-score">0</div>
            </div>
            
            <!-- COMBO DISPLAY -->
            <div class="combo-display" id="combo-display">
                COMBO x<span id="combo-mult">1</span>
            </div>
            
            <!-- ACTIVE POWERUPS -->
            <div class="powerups-display" id="powerups-display">
                <!-- JS injected -->
            </div>
            
            <!-- BOSS INFO -->
            <div class="boss-name" id="boss-name">–ì–†–ò–ù–ß</div>
            <div class="boss-hp-bar" id="boss-hp-bar">
                <div class="boss-hp-fill" id="boss-hp-fill"></div>
            </div>
            
            <!-- BOSS BATTLE CONTROLS -->
            <div class="boss-battle-controls" id="boss-battle-controls">
                <button class="throw-btn" onclick="Game.throwGift()">üéÅ</button>
            </div>
            
            <!-- ULTIMATE BUTTON -->
            <div class="ult-bar-container" onclick="Game.activateUlt()">
                <div class="ult-btn" id="ult-btn">
                    <div class="ult-fill" id="ult-fill"></div>
                    <span>SUPER</span>
                    <span style="font-size:0.6rem">SPACE</span>
                </div>
            </div>
        </div>

        <!-- MODAL: GAME OVER -->
        <div id="game-over-modal" class="modal interactive">
            <h2 style="color: var(--accent)">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
            <p>–°—á—ë—Ç: <strong id="go-score" style="font-size: 1.5rem">0</strong></p>
            <p>–ú–∞–∫—Å. –∫–æ–º–±–æ: <strong id="go-combo" style="color: var(--gold)">x0</strong></p>
            <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="go-earned" style="color:var(--gold)">+0 üü°</span></p>
            <div id="quest-complete-msg" style="display:none; color:var(--green); margin: 10px 0; font-weight:bold;">
                <!-- JS injected -->
            </div>
            <div id="achievement-unlock-msg" style="display:none; margin: 10px 0;">
                <!-- JS injected -->
            </div>
            <button class="btn" onclick="Game.returnToMenu()">–í –ú–ï–ù–Æ</button>
            <button class="btn btn-small" onclick="MiniGame.openAfterGame()">üé∞ –°–´–ì–†–ê–¢–¨ –í –ú–ò–ù–ò-–ò–ì–†–£</button>
        </div>

        <!-- MODAL: QUEST -->
        <div id="quest-modal" class="modal interactive">
            <h2>üìú –ó–∞–¥–∞–Ω–∏—è</h2>
            <div class="quest-list" id="quest-list">
                <!-- JS injected -->
            </div>
            <button class="btn btn-small" onclick="UI.closeAllModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- MODAL: ACHIEVEMENTS -->
        <div id="achievements-modal" class="modal interactive">
            <h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
            <div class="achievement-list" id="achievement-list">
                <!-- JS injected -->
            </div>
            <button class="btn btn-small" onclick="UI.closeAllModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- MODAL: LEADERBOARD -->
        <div id="leaderboard-modal" class="modal interactive">
            <h2>üèÖ –¢—É—Ä–Ω–∏—Ä–Ω–∞—è –¢–∞–±–ª–∏—Ü–∞</h2>
            <div style="margin: 15px 0;">
                <div style="font-size: 0.9rem; color: #888; margin-bottom: 10px;">
                    –¢–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω: –ó–∏–º–∞ 2024
                </div>
                <div style="font-size: 1.2rem; color: var(--gold); font-weight: bold;">
                    –í–∞—à–µ –º–µ—Å—Ç–æ: <span id="your-rank">-</span>
                </div>
            </div>
            <div class="leaderboard-list" id="leaderboard-list">
                <!-- JS injected -->
            </div>
            <button class="btn btn-small" onclick="UI.closeAllModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- MODAL: MINI GAME -->
        <div id="minigame-modal" class="modal interactive">
            <h2>üé∞ –ú–∏–Ω–∏-–∏–≥—Ä–∞</h2>
            <div class="tabs interactive" style="justify-content: center; margin-bottom: 20px;">
                <button class="tab-btn active" onclick="MiniGame.switchGame('slots')">–°–ª–æ—Ç—ã</button>
                <button class="tab-btn" onclick="MiniGame.switchGame('roulette')">–†—É–ª–µ—Ç–∫–∞</button>
            </div>
            
            <!-- SLOTS -->
            <div id="slots-game" class="minigame-container">
                <div class="slot-machine">
                    <div class="slot" id="slot1">üéÅ</div>
                    <div class="slot" id="slot2">üéÅ</div>
                    <div class="slot" id="slot3">üéÅ</div>
                </div>
                <div style="margin: 15px 0; font-size: 0.9rem;">
                    –°—Ç–æ–∏–º–æ—Å—Ç—å: <span style="color: var(--gold)">50 üü°</span>
                </div>
                <button class="btn" onclick="MiniGame.spinSlots()">–ö–†–£–¢–ò–¢–¨</button>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                    3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö = 500üü° | 2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö = 100üü°
                </div>
            </div>
            
            <!-- ROULETTE - –ò–°–ü–†–ê–í–õ–ï–ù–û -->
            <div id="roulette-game" class="minigame-container" style="display: none;">
                <div class="roulette-container">
                    <div class="roulette-pointer">‚¨áÔ∏è</div>
                    <div class="roulette-wheel" id="roulette-wheel">
                        <div class="roulette-labels">
                            <div class="roulette-label" style="transform: rotate(30deg);">x0</div>
                            <div class="roulette-label" style="transform: rotate(90deg);">x2</div>
                            <div class="roulette-label" style="transform: rotate(150deg);">x3</div>
                            <div class="roulette-label" style="transform: rotate(210deg);">x5</div>
                            <div class="roulette-label" style="transform: rotate(270deg);">x10</div>
                            <div class="roulette-label" style="transform: rotate(330deg);">x0</div>
                        </div>
                    </div>
                </div>
                <div style="margin: 15px 0; font-size: 0.9rem;">
                    –°—Ç–æ–∏–º–æ—Å—Ç—å: <span style="color: var(--gold)">100 üü°</span>
                </div>
                <button class="btn" onclick="MiniGame.spinRoulette()">–ö–†–£–¢–ò–¢–¨</button>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                    –í—ã–∏–≥—Ä—ã—à –æ—Ç x0 –¥–æ x10
                </div>
            </div>
            
            <button class="btn btn-small" style="margin-top: 15px;" onclick="UI.closeAllModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- MODAL: DAILY BONUS -->
        <div id="daily-modal" class="modal interactive">
            <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ë–æ–Ω—É—Å</h2>
            <div style="font-size: 3rem; margin: 20px;">üéÅ</div>
            <p id="daily-msg">–ó–∞—Ö–æ–¥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!</p>
            <button class="btn" id="btn-claim-daily" onclick="Meta.claimDaily()">–ó–ê–ë–†–ê–¢–¨</button>
            <button class="btn btn-small" onclick="UI.closeAllModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- MODAL: NO LIVES -->
        <div id="no-lives-modal" class="modal interactive">
            <h2>–ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫!</h2>
            <p>–ñ–¥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.</p>
            <div class="timer-display" id="modal-timer" style="font-size: 1.5rem; color: var(--primary); margin: 15px 0;">
                00:00:00
            </div>
            <button class="btn btn-small" onclick="UI.closeAllModals()">–û–∫</button>
        </div>
    </div>

<script>
/* ============================================
   AUDIO SYSTEM
   ============================================ */
const AudioSys = {
    ctx: null,
    init() { 
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
        if(this.ctx.state==='suspended') this.ctx.resume(); 
    },
    play(type) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain); 
        gain.connect(this.ctx.destination);
        const t = this.ctx.currentTime;
        
        if (type === 'catch' || type === 'coin') {
            osc.frequency.setValueAtTime(600, t); 
            osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
            gain.gain.setValueAtTime(0.1, t); 
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'shatter') {
            osc.type = 'square'; 
            osc.frequency.setValueAtTime(800, t); 
            osc.frequency.exponentialRampToValueAtTime(100, t + 0.1);
            gain.gain.setValueAtTime(0.2, t); 
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
            osc.start(t); osc.stop(t + 0.15);
        } else if (type === 'hit') {
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(100, t); 
            osc.frequency.linearRampToValueAtTime(50, t + 0.3);
            gain.gain.setValueAtTime(0.3, t); 
            gain.gain.linearRampToValueAtTime(0.01, t + 0.3);
            osc.start(t); osc.stop(t + 0.3);
        } else if (type === 'boss_start') {
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(100, t); 
            osc.frequency.linearRampToValueAtTime(400, t+1);
            gain.gain.setValueAtTime(0.2, t); 
            gain.gain.linearRampToValueAtTime(0, t+1);
            osc.start(t); osc.stop(t+1);
        } else if (type === 'ult') {
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(100, t); 
            osc.frequency.linearRampToValueAtTime(800, t+0.5);
            gain.gain.setValueAtTime(0.3, t); 
            gain.gain.linearRampToValueAtTime(0, t+0.5);
            osc.start(t); osc.stop(t+0.5);
        } else if (type === 'powerup') {
            osc.frequency.setValueAtTime(400, t); 
            osc.frequency.exponentialRampToValueAtTime(800, t + 0.2);
            gain.gain.setValueAtTime(0.15, t); 
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
            osc.start(t); osc.stop(t + 0.2);
        } else if (type === 'throw') {
            osc.frequency.setValueAtTime(300, t);
            osc.frequency.linearRampToValueAtTime(600, t + 0.1);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'boss_hit') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, t);
            osc.frequency.exponentialRampToValueAtTime(50, t + 0.2);
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.2);
            osc.start(t); osc.stop(t + 0.2);
        } else if (type === 'achievement') {
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.linearRampToValueAtTime(1200, t + 0.3);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.3);
            osc.start(t); osc.stop(t + 0.3);
        } else if (type === 'win') {
            osc.frequency.setValueAtTime(500, t);
            osc.frequency.linearRampToValueAtTime(1000, t + 0.5);
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.5);
            osc.start(t); osc.stop(t + 0.5);
        }
    }
};

/* ============================================
   CONFIG & DATA
   ============================================ */
const UPGRADES = {
    speed: { name: "–°–∫–æ—Ä–æ—Ö–æ–¥—ã", icon: "üëü", base: 500, inc: 100, cost: 200, max: 5, desc: "+–°–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥–∞" },
    luck:  { name: "–£–¥–∞—á–∞", icon: "üçÄ", base: 1, inc: 0.2, cost: 500, max: 5, desc: "–ë–æ–ª—å—à–µ –±–æ–Ω—É—Å–æ–≤" },
    magnet:{ name: "–ú–∞–≥–Ω–∏—Ç+", icon: "üß≤", base: 0, inc: 0, cost: 300, max: 5, desc: "–†–∞–¥–∏—É—Å –º–∞–≥–Ω–∏—Ç–∞" },
    time:  { name: "–í—Ä–µ–º—è+", icon: "‚è≥", base: 5, inc: 2, cost: 400, max: 5, desc: "–ë–æ–Ω—É—Å—ã –¥–æ–ª—å—à–µ" },
    damage: { name: "–°–∏–ª–∞", icon: "üí™", base: 1, inc: 1, cost: 600, max: 5, desc: "–£—Ä–æ–Ω –±–æ—Å—Å—É" }
};

const SKINS = {
    'santa': { id: 'santa', icon: 'üéÖ', name: '–°–∞–Ω—Ç–∞', cost: 0 },
    'snowman': { id: 'snowman', icon: '‚õÑ', name: '–°–Ω–µ–≥–æ–≤–∏–∫', cost: 2000 },
    'deer': { id: 'deer', icon: 'ü¶å', name: '–†—É–¥–æ–ª—å—Ñ', cost: 5000 },
    'ninja': { id: 'ninja', icon: 'ü•∑', name: '–ù–∏–Ω–¥–∑—è', cost: 8000 },
    'rocket': { id: 'rocket', icon: 'üöÄ', name: '–†–∞–∫–µ—Ç–∞', cost: 15000 }
};

const FACTORY = {
    elf: { name: "–≠–ª—å—Ñ-–†–∞–±–æ—á–∏–π", icon: "üë∑", baseCost: 100, income: 1 },
    machine: { name: "–£–ø–∞–∫–æ–≤—â–∏–∫", icon: "‚öôÔ∏è", baseCost: 1000, income: 12 }
};

const PETS = {
    lexi: { 
        id: 'lexi', 
        name: '–õ–µ–∫—Å–∏', 
        icon: 'üêï', 
        cost: 10000, 
        maxLevel: 10,
        baseInterval: 10,
        desc: '–ê–≤—Ç–æ—Å–æ–±–∏—Ä–∞–µ—Ç 1 –ø–æ–¥–∞—Ä–æ–∫'
    }
};

const ASSETS = {
    GIFTS: ["üéÅ", "üß∏", "üç¨", "üçä", "üöÇ"],
    BAD: ["‚ö´", "üí©"],
    ICE: "üßä",
    BOSS: "üë∫",
    BOSS_PROJ: "‚ùÑÔ∏è",
    POWERUPS: {
        shield: { icon: "üõ°Ô∏è", color: "#3b82f6", name: "–©–ò–¢" },
        magnet: { icon: "üß≤", color: "#f59e0b", name: "–ú–ê–ì–ù–ò–¢" },
        double: { icon: "‚úñÔ∏è2", color: "#22c55e", name: "x2" },
        slow: { icon: "üêå", color: "#a855f7", name: "–ó–ê–ú–ï–î–õ–ï–ù–ò–ï" }
    }
};

const CONFIG = {
    GAME_WIDTH: 600, 
    GAME_HEIGHT: 800,
    BOSS_TIME: 30,
    BOSS_BATTLE_DURATION: 20,
    MAX_ATTEMPTS: 4,
    POWERUP_DURATION: 8,
    COMBO_TIMEOUT: 2
};

const QUEST_TEMPLATES = [
    { id: 1, desc: "–ü–æ–π–º–∞–π 50 –ø–æ–¥–∞—Ä–∫–æ–≤", target: 50, reward: 300, type: 'gifts' },
    { id: 2, desc: "–ù–∞–±–µ—Ä–∏ 500 –æ—á–∫–æ–≤", target: 500, reward: 400, type: 'score' },
    { id: 3, desc: "–ü–æ–±–µ–¥–∏ –ì—Ä–∏–Ω—á–∞ 1 —Ä–∞–∑", target: 1, reward: 500, type: 'boss' },
    { id: 4, desc: "–ü–æ–π–º–∞–π 3 –±–æ–Ω—É—Å–∞", target: 3, reward: 250, type: 'powerups' },
    { id: 5, desc: "–†–∞–∑–±–µ–π 10 –ª—å–¥–∏–Ω–æ–∫", target: 10, reward: 200, type: 'ice' },
    { id: 6, desc: "–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x5", target: 5, reward: 350, type: 'combo' },
    { id: 7, desc: "–ò–≥—Ä–∞–π 60 —Å–µ–∫—É–Ω–¥", target: 60, reward: 300, type: 'time' },
    { id: 8, desc: "–ü–æ–π–º–∞–π 100 –ø–æ–¥–∞—Ä–∫–æ–≤", target: 100, reward: 600, type: 'gifts' },
    { id: 9, desc: "–ù–∞–±–µ—Ä–∏ 1000 –æ—á–∫–æ–≤", target: 1000, reward: 800, type: 'score' },
    { id: 10, desc: "–ü–æ–±–µ–¥–∏ –ì—Ä–∏–Ω—á–∞ 3 —Ä–∞–∑–∞", target: 3, reward: 1000, type: 'boss' }
];

const ACHIEVEMENTS = [
    { id: 'first_game', name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', desc: '–°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –∏–≥—Ä—É', icon: 'üéÆ', reward: 100, check: (stats) => stats.gamesPlayed >= 1 },
    { id: 'combo_master', name: '–ú–∞—Å—Ç–µ—Ä –∫–æ–º–±–æ', desc: '–ù–∞–±–µ—Ä–∏ –∫–æ–º–±–æ x10', icon: 'üî•', reward: 500, check: (stats) => stats.maxCombo >= 10 },
    { id: 'boss_slayer', name: '–£–±–∏–π—Ü–∞ –±–æ—Å—Å–æ–≤', desc: '–ü–æ–±–µ–¥–∏ 5 –±–æ—Å—Å–æ–≤', icon: '‚öîÔ∏è', reward: 1000, check: (stats) => stats.totalBosses >= 5 },
    { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', desc: '–ü–æ–π–º–∞–π 500 –ø–æ–¥–∞—Ä–∫–æ–≤', icon: 'üì¶', reward: 800, check: (stats) => stats.totalGifts >= 500 },
    { id: 'rich', name: '–ë–æ–≥–∞—á', desc: '–ù–∞–∫–æ–ø–∏ 50000 –º–æ–Ω–µ—Ç', icon: 'üí∞', reward: 2000, check: (stats) => stats.totalCoins >= 50000 },
    { id: 'survivor', name: '–í—ã–∂–∏–≤–∞–ª—å—â–∏–∫', desc: '–ü—Ä–æ–∂–∏–≤–∏ 120 —Å–µ–∫—É–Ω–¥', icon: '‚è±Ô∏è', reward: 600, check: (stats) => stats.maxTime >= 120 },
    { id: 'fashionista', name: '–ú–æ–¥–Ω–∏–∫', desc: '–ö—É–ø–∏ 3 —Å–∫–∏–Ω–∞', icon: 'üëî', reward: 1500, check: (stats) => stats.skinsOwned >= 3 },
    { id: 'pet_owner', name: '–•–æ–∑—è–∏–Ω –ø–∏—Ç–æ–º—Ü–∞', desc: '–ö—É–ø–∏ –õ–µ–∫—Å–∏', icon: 'üêï', reward: 3000, check: (stats) => stats.hasPet === true },
    { id: 'factory_owner', name: '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∏–∫', desc: '–ö—É–ø–∏ 10 —ç–ª—å—Ñ–æ–≤', icon: 'üè≠', reward: 1000, check: (stats) => stats.totalWorkers >= 10 },
    { id: 'perfect_game', name: '–ò–¥–µ–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞', desc: '–ó–∞–∫–æ–Ω—á–∏ –∏–≥—Ä—É –±–µ–∑ —É—Ä–æ–Ω–∞', icon: 'üíé', reward: 5000, check: (stats) => stats.noDamageGames >= 1 }
];

const STORY = [
    "üéÑ –ù–æ–≤—ã–π –ì–æ–¥ –Ω–∞ –Ω–æ—Å—É, –∏ –°–µ–≤–µ—Ä–Ω—ã–π –ü–æ–ª—é—Å –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ –ø—Ä–∞–∑–¥–Ω–∏–∫—É!",
    "üéÖ –°–∞–Ω—Ç–∞ –∏ –µ–≥–æ —ç–ª—å—Ñ—ã —É–ø–∞–∫–æ–≤—ã–≤–∞—é—Ç –ø–æ–¥–∞—Ä–∫–∏ –¥–ª—è –¥–µ—Ç–µ–π –≤—Å–µ–≥–æ –º–∏—Ä–∞.",
    "üòà –ù–æ –∑–ª–æ–±–Ω—ã–π –ì—Ä–∏–Ω—á –∑–∞–¥—É–º–∞–ª —É–∫—Ä–∞—Å—Ç—å –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏!",
    "‚ùÑÔ∏è –û–Ω –∑–∞–º–æ—Ä–æ–∑–∏–ª –ø–æ–¥–∞—Ä–∫–∏ –≤ –ª—ë–¥ –∏ —Ä–∞–∑–±—Ä–æ—Å–∞–ª –∏—Ö –ø–æ –Ω–µ–±—É!",
    "üí™ –ü–æ–º–æ–≥–∏ –°–∞–Ω—Ç–µ —Å–æ–±—Ä–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –∏ –ø–æ–±–µ–¥–∏—Ç—å –ì—Ä–∏–Ω—á–∞!",
    "üéÅ –°–æ–±–∏—Ä–∞–π –ø–æ–¥–∞—Ä–∫–∏, —É–ª—É—á—à–∞–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —Å–ø–∞—Å–∏ –ù–æ–≤—ã–π –ì–æ–¥!"
];

const TUTORIAL_STEPS = [
    {
        icon: "üéÆ",
        title: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
        desc: "–ü–µ—Ä–µ–º–µ—â–∞–π –°–∞–Ω—Ç—É –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ —Å –ø–æ–º–æ—â—å—é –º—ã—à–∏, –∫–∞—Å–∞–Ω–∏—è –∏–ª–∏ —Å—Ç—Ä–µ–ª–æ–∫ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ. –°–æ–±–∏—Ä–∞–π –ø–∞–¥–∞—é—â–∏–µ –ø–æ–¥–∞—Ä–∫–∏!",
    },
    {
        icon: "üéÅ",
        title: "–ü–æ–¥–∞—Ä–∫–∏",
        desc: "–ó–µ–ª—ë–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –¥–∞—é—Ç –æ—á–∫–∏. –ò–∑–±–µ–≥–∞–π —á—ë—Ä–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ - –æ–Ω–∏ –æ—Ç–Ω–∏–º–∞—é—Ç –∂–∏–∑–Ω–∏! –£ —Ç–µ–±—è 3 –∂–∏–∑–Ω–∏ ‚ù§Ô∏è",
    },
    {
        icon: "üßä",
        title: "–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏",
        desc: "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã –≤–æ –ª—å–¥—É. –ö–ª–∏–∫–∞–π –ø–æ –Ω–∏–º, —á—Ç–æ–±—ã —Ä–∞–∑–±–∏—Ç—å –ª—ë–¥ –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫!",
    },
    {
        icon: "üõ°Ô∏è",
        title: "–ë–æ–Ω—É—Å—ã",
        desc: "–õ–æ–≤–∏—Ç–µ –±–æ–Ω—É—Å—ã: –©–ò–¢ –∑–∞—â–∏—â–∞–µ—Ç, –ú–ê–ì–ù–ò–¢ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç, x2 —É–¥–≤–∞–∏–≤–∞–µ—Ç –æ—á–∫–∏, –ó–ê–ú–ï–î–õ–ï–ù–ò–ï –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç—ã!",
    },
    {
        icon: "üëπ",
        title: "–ë–∏—Ç–≤–∞ —Å –ì—Ä–∏–Ω—á–µ–º",
        desc: "–ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—è–≤–∏—Ç—Å—è –ì—Ä–∏–Ω—á! –£–≤–æ—Ä–∞—á–∏–≤–∞–π—Å—è –æ—Ç —Å–Ω–µ–∂–∫–æ–≤, –ø–æ—Ç–æ–º –∫–∏–¥–∞–π –≤ –Ω–µ–≥–æ –ø–æ–¥–∞—Ä–∫–∏, —á—Ç–æ–±—ã –ø–æ–±–µ–¥–∏—Ç—å!",
    }
];

const LOADING_TIPS = [
    "üí° –ò—Å–ø–æ–ª—å–∑—É–π SPACE –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å—É–ø–µ—Ä-—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏!",
    "üß≤ –ú–∞–≥–Ω–∏—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ç—ã –ø–æ–π–º–∞–µ—à—å –±–æ–Ω—É—Å!",
    "üî• –°–æ–±–∏—Ä–∞–π –ø–æ–¥–∞—Ä–∫–∏ –ø–æ–¥—Ä—è–¥ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ–º–±–æ!",
    "üëπ –£ –ì—Ä–∏–Ω—á–∞ 100 HP - –∫–∞—á–∞–π —É—Ä–æ–Ω!",
    "üêï –õ–µ–∫—Å–∏ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!",
    "üè≠ –≠–ª—å—Ñ—ã –ø—Ä–∏–Ω–æ—Å—è—Ç –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥!",
    "üé∞ –ò–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—ã –¥–ª—è –±–æ–Ω—É—Å–æ–≤!",
    "üèÜ –í—ã–ø–æ–ª–Ω—è–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è –Ω–∞–≥—Ä–∞–¥!",
    "üìú –°–ª–µ–¥–∏ –∑–∞ –∫–≤–µ—Å—Ç–∞–º–∏ - –æ–Ω–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –º–Ω–æ–≥–æ –º–æ–Ω–µ—Ç!"
];

/* ============================================
   LOADING & TUTORIAL SYSTEM
   ============================================ */
const LoadingSystem = {
    progress: 0,
    
    async start() {
        const isFirstTime = !Meta.data.tutorialCompleted;
        
        if (isFirstTime) {
            await this.showStory();
        } else {
            // –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
            await this.quickLoad();
        }
        
        document.getElementById('loading-screen').classList.add('hidden');
        
        if (isFirstTime) {
            Tutorial.start();
        } else {
            UI.showScreen('menu');
        }
    },
    
    async quickLoad() {
        const loadingText = document.getElementById('loading-text');
        loadingText.innerText = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ!";
        await this.simulateProgress(100);
        await this.delay(500);
    },
    
    async showStory() {
        const storyContainer = document.getElementById('story-container');
        const storyText = document.getElementById('story-text');
        storyContainer.style.display = 'block';
        
        for (let text of STORY) {
            storyText.innerText = text;
            await this.simulateProgress(100 / STORY.length);
            await this.delay(2500);
        }
    },
    
    async simulateProgress(targetIncrease) {
        const fill = document.getElementById('loading-fill');
        const target = this.progress + targetIncrease;
        const steps = 20;
        const increment = targetIncrease / steps;
        
        for (let i = 0; i < steps; i++) {
            this.progress += increment;
            fill.style.width = Math.min(this.progress, 100) + '%';
            await this.delay(50);
        }
    },
    
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
};

const Tutorial = {
    currentStep: 0,
    
    start() {
        this.currentStep = 0;
        this.show();
    },
    
    show() {
        const step = TUTORIAL_STEPS[this.currentStep];
        document.getElementById('tutorial-icon').innerText = step.icon;
        document.getElementById('tutorial-title').innerText = step.title;
        document.getElementById('tutorial-desc').innerText = step.desc;
        document.getElementById('tutorial-step').innerText = `–®–∞–≥ ${this.currentStep + 1}/${TUTORIAL_STEPS.length}`;
        
        UI.showScreen('tutorial');
    },
    
    next() {
        this.currentStep++;
        if (this.currentStep < TUTORIAL_STEPS.length) {
            this.show();
        } else {
            this.complete();
        }
    },
    
    complete() {
        Meta.data.tutorialCompleted = true;
        Meta.save();
        document.getElementById('tutorial-screen').classList.add('hidden');
        UI.showScreen('menu');
    }
};

/* ============================================
   META DATA MANAGER
   ============================================ */
const Meta = {
    data: { 
        attempts: 4, 
        nextRefill: 0, 
        wallet: 0, 
        bestScore: 0, 
        upgrades: { speed: 0, luck: 0, magnet: 0, time: 0, damage: 0 },
        skins: ['santa'], 
        currentSkin: 'santa', 
        factory: { elf: 0, machine: 0 },
        pets: {},
        lastIdleCheck: Date.now(),
        idleBank: 0,
        quests: [
            { id: 1, progress: 0, completed: false }
        ],
        achievements: [],
        questsCompleted: 0,
        stats: {
            totalGifts: 0,
            totalBosses: 0,
            maxCombo: 0,
            gamesPlayed: 0,
            totalCoins: 0,
            maxTime: 0,
            skinsOwned: 1,
            hasPet: false,
            totalWorkers: 0,
            noDamageGames: 0
        },
        leaderboard: [],
        tutorialCompleted: false,
        lastLogin: 0 
    },
    
    init() {
        const s = localStorage.getItem('ny_ultimate_v4');
        if (s) {
            this.data = JSON.parse(s);
            if (!this.data.quests || this.data.quests.length === 0) {
                this.data.quests = [{ id: 1, progress: 0, completed: false }];
            }
            if (!this.data.stats) {
                this.data.stats = { totalGifts: 0, totalBosses: 0, maxCombo: 0, gamesPlayed: 0, totalCoins: 0, maxTime: 0, skinsOwned: 1, hasPet: false, totalWorkers: 0, noDamageGames: 0 };
            }
            if (!this.data.achievements) {
                this.data.achievements = [];
            }
            if (!this.data.pets) {
                this.data.pets = {};
            }
        }
        this.checkRefill();
        this.calcIdle();
        setInterval(() => this.calcIdle(), 1000);
        this.updateStats();
    },
    
    save() { 
        localStorage.setItem('ny_ultimate_v4', JSON.stringify(this.data)); 
        UI.updateMenu(); 
    },
    
    checkRefill() {
        const now = Date.now();
        if (this.data.attempts < 4 && now > this.data.nextRefill) {
            this.data.attempts++;
            this.data.nextRefill = (this.data.attempts < 4) ? now + (8*3600*1000) : 0;
            this.save(); 
            this.checkRefill();
        }
    },
    
    calcIdle() {
        const now = Date.now();
        const dt = (now - this.data.lastIdleCheck) / 1000;
        if (dt >= 1) {
            const incomePerSec = (this.data.factory.elf * FACTORY.elf.income) + 
                                 (this.data.factory.machine * FACTORY.machine.income);
            if (incomePerSec > 0) {
                this.data.idleBank += incomePerSec * dt;
            }
            this.data.lastIdleCheck = now;
            this.save();
        }
        this.checkRefill();
    },
    
    claimIdle() {
        if (this.data.idleBank >= 1) {
            const amount = Math.floor(this.data.idleBank);
            this.data.wallet += amount;
            this.data.stats.totalCoins += amount;
            this.data.idleBank = 0;
            AudioSys.play('coin');
            this.save();
            this.checkAchievements();
        }
    },
    
    addScore(s) {
        this.data.wallet += s;
        this.data.stats.totalCoins += s;
        if (s > this.data.bestScore) this.data.bestScore = s;
        this.save();
        this.checkAchievements();
    },
    
    buyUpgrade(key) {
        const lvl = this.data.upgrades[key];
        if (lvl >= UPGRADES[key].max) return;
        const cost = Math.floor(UPGRADES[key].cost * Math.pow(1.5, lvl));
        if (this.data.wallet >= cost) {
            this.data.wallet -= cost;
            this.data.upgrades[key]++;
            this.save();
            UI.renderContent();
        }
    },
    
    buyFactory(key) {
        const count = this.data.factory[key];
        const cost = Math.floor(FACTORY[key].baseCost * Math.pow(1.2, count));
        if (this.data.wallet >= cost) {
            this.data.wallet -= cost;
            this.data.factory[key]++;
            this.updateStats();
            this.save();
            UI.renderContent();
            this.checkAchievements();
        }
    },
    
    buySkin(id) {
        const cost = SKINS[id].cost;
        if (this.data.skins.includes(id)) {
            this.data.currentSkin = id;
            this.save();
            UI.renderContent();
            return true;
        } else if (this.data.wallet >= cost) {
            this.data.wallet -= cost;
            this.data.skins.push(id);
            this.data.currentSkin = id;
            this.updateStats();
            this.save();
            UI.renderContent();
            this.checkAchievements();
            return true;
        }
        return false;
    },
    
    buyPet(id) {
        const pet = PETS[id];
        if (this.data.pets[id]) {
            const currentLevel = this.data.pets[id].level;
            if (currentLevel >= pet.maxLevel) return false;
            const upgradeCost = Math.floor(pet.cost * Math.pow(1.5, currentLevel));
            if (this.data.wallet >= upgradeCost) {
                this.data.wallet -= upgradeCost;
                this.data.pets[id].level++;
                this.save();
                UI.renderContent();
                return true;
            }
        } else {
            if (this.data.wallet >= pet.cost) {
                this.data.wallet -= pet.cost;
                this.data.pets[id] = { level: 1, lastCollect: Date.now() };
                this.data.stats.hasPet = true;
                this.save();
                UI.renderContent();
                this.checkAchievements();
                return true;
            }
        }
        return false;
    },
    
    useAttempt() {
        if (this.data.attempts > 0) {
            if (this.data.attempts === 4) this.data.nextRefill = Date.now() + (8*3600*1000);
            this.data.attempts--;
            this.save(); 
            return true;
        }
        return false;
    },
    
    updateQuest(type, amount = 1) {
        let anyCompleted = false;
        this.data.quests.forEach(quest => {
            if (quest.completed) return;
            
            const template = QUEST_TEMPLATES.find(t => t.id === quest.id);
            if (template && template.type === type) {
                quest.progress += amount;
                if (quest.progress >= template.target && !quest.completed) {
                    quest.completed = true;
                    this.data.wallet += template.reward;
                    this.data.stats.totalCoins += template.reward;
                    this.data.questsCompleted++;
                    anyCompleted = true;
                    
                    const nextQuestId = quest.id + 1;
                    if (nextQuestId <= QUEST_TEMPLATES.length) {
                        const exists = this.data.quests.find(q => q.id === nextQuestId);
                        if (!exists) {
                            this.data.quests.push({ id: nextQuestId, progress: 0, completed: false });
                        }
                    }
                }
            }
        });
        
        if (anyCompleted) {
            this.save();
        }
        return anyCompleted;
    },
    
    checkAchievements() {
        let newUnlocks = [];
        ACHIEVEMENTS.forEach(achievement => {
            if (!this.data.achievements.includes(achievement.id)) {
                if (achievement.check(this.data.stats)) {
                    this.data.achievements.push(achievement.id);
                    this.data.wallet += achievement.reward;
                    this.data.stats.totalCoins += achievement.reward;
                    newUnlocks.push(achievement);
                    AudioSys.play('achievement');
                }
            }
        });
        
        if (newUnlocks.length > 0) {
            this.save();
        }
        
        return newUnlocks;
    },
    
    updateStats() {
        this.data.stats.skinsOwned = this.data.skins.length;
        this.data.stats.totalWorkers = (this.data.factory.elf || 0) + (this.data.factory.machine || 0);
        this.data.stats.hasPet = Object.keys(this.data.pets).length > 0;
    },
    
    updateLeaderboard(score) {
        const playerName = "–ò–≥—Ä–æ–∫";
        this.data.leaderboard.push({ name: playerName, score, date: Date.now() });
        this.data.leaderboard.sort((a, b) => b.score - a.score);
        this.data.leaderboard = this.data.leaderboard.slice(0, 100);
        this.save();
    },
    
    claimDaily() { 
        this.data.wallet += 200; 
        this.data.stats.totalCoins += 200;
        this.save(); 
        UI.closeAllModals(); 
        alert('–ü–æ–ª—É—á–µ–Ω–æ 200 üü°');
        this.checkAchievements();
    }
};

/* ============================================
   MINI GAMES
   ============================================ */
const MiniGame = {
    currentGame: 'slots',
    isSpinning: false,
    
    switchGame(game) {
        this.currentGame = game;
        document.getElementById('slots-game').style.display = game === 'slots' ? 'block' : 'none';
        document.getElementById('roulette-game').style.display = game === 'roulette' ? 'block' : 'none';
        
        document.querySelectorAll('#minigame-modal .tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    },
    
    async spinSlots() {
        if (this.isSpinning) return;
        if (Meta.data.wallet < 50) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
            return;
        }
        
        this.isSpinning = true;
        Meta.data.wallet -= 50;
        Meta.save();
        
        AudioSys.play('coin');
        
        const symbols = ['üéÅ', 'üß∏', 'üç¨', '‚≠ê', 'üíé'];
        const slots = [
            document.getElementById('slot1'),
            document.getElementById('slot2'),
            document.getElementById('slot3')
        ];
        
        for (let i = 0; i < 20; i++) {
            slots.forEach(slot => {
                slot.innerText = symbols[Math.floor(Math.random() * symbols.length)];
            });
            await this.delay(100);
        }
        
        const luck = Math.random();
        let results;
        
        if (luck < 0.05) {
            const sameSymbol = symbols[Math.floor(Math.random() * symbols.length)];
            results = [sameSymbol, sameSymbol, sameSymbol];
        } else if (luck < 0.20) {
            const sameSymbol = symbols[Math.floor(Math.random() * symbols.length)];
            const diff = symbols[Math.floor(Math.random() * symbols.length)];
            results = [sameSymbol, sameSymbol, diff];
        } else {
            results = [
                symbols[Math.floor(Math.random() * symbols.length)],
                symbols[Math.floor(Math.random() * symbols.length)],
                symbols[Math.floor(Math.random() * symbols.length)]
            ];
            while (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                results[2] = symbols[Math.floor(Math.random() * symbols.length)];
            }
        }
        
        slots[0].innerText = results[0];
        slots[1].innerText = results[1];
        slots[2].innerText = results[2];
        
        let winAmount = 0;
        if (results[0] === results[1] && results[1] === results[2]) {
            winAmount = 500;
            this.showWinNotification("–î–ñ–ï–ö–ü–û–¢! +500 üü°");
            AudioSys.play('win');
        } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
            winAmount = 100;
            this.showWinNotification("–í—ã–∏–≥—Ä—ã—à! +100 üü°");
            AudioSys.play('powerup');
        } else {
            this.showWinNotification("–£–≤—ã! –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑");
        }
        
        if (winAmount > 0) {
            Meta.data.wallet += winAmount;
            Meta.data.stats.totalCoins += winAmount;
            Meta.save();
        }
        
        this.isSpinning = false;
    },
    
    async spinRoulette() {
        if (this.isSpinning) return;
        if (Meta.data.wallet < 100) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
            return;
        }
        
        this.isSpinning = true;
        Meta.data.wallet -= 100;
        Meta.save();
        
        AudioSys.play('coin');
        
        const wheel = document.getElementById('roulette-wheel');
        
        // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—Ä–∞—â–µ–Ω–∏—è
        wheel.style.transition = 'none';
        wheel.style.transform = 'rotate(0deg)';
        void wheel.offsetWidth; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow
        
        const rand = Math.random();
        let sector;
        
        if (rand < 0.35) sector = 0; // x0 (35%)
        else if (rand < 0.60) sector = 1; // x2 (25%)
        else if (rand < 0.80) sector = 2; // x3 (20%)
        else if (rand < 0.95) sector = 3; // x5 (15%)
        else sector = 4; // x10 (5%)
        
        const multipliers = [0, 2, 3, 5, 10, 0];
        
        if (sector === 0 && Math.random() < 0.5) {
            sector = 5;
        }
        
        // 6 —Å–µ–∫—Ç–æ—Ä–æ–≤ –ø–æ 60 –≥—Ä–∞–¥—É—Å–æ–≤ –∫–∞–∂–¥—ã–π
        // –°—Ç—Ä–µ–ª–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –≤–≤–µ—Ä—Ö (0¬∞), –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —É–≥–æ–ª
        const sectorAngle = 60;
        const targetAngle = sector * sectorAngle + (Math.random() * 40 - 20);
        const fullRotations = 360 * 5;
        const degrees = fullRotations + targetAngle;
        
        wheel.style.transition = 'transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
        wheel.style.transform = `rotate(${degrees}deg)`;
        
        await this.delay(3000);
        
        const winMultiplier = multipliers[sector];
        const winAmount = 100 * winMultiplier;
        
        if (winAmount > 0) {
            Meta.data.wallet += winAmount;
            Meta.data.stats.totalCoins += winAmount;
            Meta.save();
            this.showWinNotification(`x${winMultiplier}! –í—ã–∏–≥—Ä—ã—à: +${winAmount} üü°`);
            AudioSys.play('win');
        } else {
            this.showWinNotification("–£–≤—ã! –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑");
        }
        
        this.isSpinning = false;
    },
    
    showWinNotification(text) {
        const notification = document.createElement('div');
        notification.className = 'win-notification';
        notification.innerText = text;
        document.getElementById('game-container').appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 2000);
    },
    
    openAfterGame() {
        UI.closeAllModals();
        setTimeout(() => {
            UI.openModal('minigame-modal');
        }, 100);
    },
    
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
};

/* ============================================
   WEATHER SYSTEM
   ============================================ */
const Weather = {
    current: null,
    particles: [],
    intervalId: null,
    
    start(type) {
        this.stop();
        this.current = type;
        
        if (type === 'snow' || type === 'blizzard') {
            this.createSnow(type === 'blizzard' ? 50 : 20);
        } else if (type === 'fireworks') {
            this.createFireworks();
        }
    },
    
    stop() {
        const container = document.getElementById('weather-overlay');
        container.innerHTML = '';
        this.particles = [];
        this.current = null;
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
        }
    },
    
    createSnow(count) {
        const container = document.getElementById('weather-overlay');
        for (let i = 0; i < count; i++) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.innerText = '‚ùÑÔ∏è';
            snowflake.style.left = Math.random() * 100 + '%';
            snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
            snowflake.style.animationDelay = Math.random() * 2 + 's';
            snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
            container.appendChild(snowflake);
        }
    },
    
    createFireworks() {
        const container = document.getElementById('weather-overlay');
        this.intervalId = setInterval(() => {
            if (this.current !== 'fireworks') return;
            
            const firework = document.createElement('div');
            firework.innerText = 'üéÜ';
            firework.style.position = 'absolute';
            firework.style.left = Math.random() * 100 + '%';
            firework.style.top = Math.random() * 50 + '%';
            firework.style.fontSize = '3rem';
            firework.style.animation = 'floatUp 2s forwards';
            container.appendChild(firework);
            
            setTimeout(() => firework.remove(), 2000);
        }, 1000);
    },
    
    randomWeather() {
        const types = ['snow', 'blizzard', 'fireworks'];
        const random = types[Math.floor(Math.random() * types.length)];
        this.start(random);
    }
};

/* ============================================
   GAME ENGINE
   ============================================ */
class GameEngine {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        this.input = { x: 0, y: 0, active: false };
        this.keys = { left: false, right: false };
        
        const inputMove = (x, y) => { 
            if(this.running && !this.bossBattleMode) { 
                const rect = this.canvas.getBoundingClientRect();
                this.input.x = Math.max(30, Math.min(this.width-30, x - rect.left)); 
                this.input.y = y - rect.top;
                this.input.active = true; 
            }
        };
        
        const inputEnd = () => {
            this.input.active = false;
        };
        
        window.addEventListener('mousemove', e => {
            if (this.input.active) inputMove(e.clientX, e.clientY);
        });
        
        window.addEventListener('mousedown', e => {
            inputMove(e.clientX, e.clientY);
        });
        
        window.addEventListener('mouseup', inputEnd);
        
        this.canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const touch = e.touches[0];
            inputMove(touch.clientX, touch.clientY);
        }, {passive:false});
        
        this.canvas.addEventListener('touchmove', e => { 
            e.preventDefault();
            const touch = e.touches[0];
            inputMove(touch.clientX, touch.clientY);
        }, {passive:false});
        
        this.canvas.addEventListener('touchend', e => {
            e.preventDefault();
            inputEnd();
        }, {passive:false});

        // –ò–°–ü–†–ê–í–õ–ï–ù–û: Click –¥–ª—è —Ä–∞–∑–±–∏—Ç–∏—è –ª—å–¥–∞
        const inputClick = (cx, cy) => {
            if (!this.running) return;
            const rect = this.canvas.getBoundingClientRect();
            const x = cx - rect.left;
            const y = cy - rect.top;
            this.handleInputClick(x, y);
        };
        
        this.canvas.addEventListener('click', e => inputClick(e.clientX, e.clientY));
        this.canvas.addEventListener('touchend', e => {
            if (e.changedTouches.length > 0) {
                const touch = e.changedTouches[0];
                inputClick(touch.clientX, touch.clientY);
            }
        });

        window.addEventListener('keydown', e => { 
            if(e.key==='ArrowLeft'||e.key==='a') this.keys.left=true; 
            if(e.key==='ArrowRight'||e.key==='d') this.keys.right=true; 
            if(e.code==='Space') this.activateUlt();
        });
        window.addEventListener('keyup', e => { 
            if(e.key==='ArrowLeft'||e.key==='a') this.keys.left=false; 
            if(e.key==='ArrowRight'||e.key==='d') this.keys.right=false; 
        });

        this.player = { x: 0, angle: 0, skin: 'üéÖ' };
        this.pet = null;
        this.running = false;
        this.bossBattleMode = false;
        this.loop = this.loop.bind(this);
    }

    resize() {
        const r = document.getElementById('game-container').getBoundingClientRect();
        this.canvas.width = this.width = r.width;
        this.canvas.height = this.height = r.height;
    }

    start() {
        AudioSys.init();
        this.running = true;
        this.score = 0;
        this.lives = 3;
        this.gameTime = 0;
        this.objects = [];
        this.particles = [];
        this.trail = [];
        this.ultCharge = 0;
        this.lastTime = performance.now();
        this.bossBattleMode = false;
        this.damageTaken = 0;
        
        this.combo = 0;
        this.maxCombo = 0;
        this.lastCatchTime = 0;
        
        this.sessionStats = {
            gifts: 0,
            powerups: 0,
            ice: 0,
            bosses: 0
        };
        
        this.player.x = this.width/2;
        this.player.skin = SKINS[Meta.data.currentSkin].icon;
        
        if (Meta.data.pets.lexi) {
            this.pet = {
                x: this.player.x - 50,
                y: this.height - 20,
                lastCollect: Date.now(),
                interval: PETS.lexi.baseInterval - (Meta.data.pets.lexi.level * 0.5)
            };
        }
        
        this.powerups = {
            shield: { active: false, timer: 0 },
            magnet: { active: false, timer: 0 },
            double: { active: false, timer: 0 },
            slow: { active: false, timer: 0 }
        };
        
        this.stats = {
            speed: UPGRADES.speed.base + (Meta.data.upgrades.speed * UPGRADES.speed.inc),
            magnetLevel: Meta.data.upgrades.magnet,
            luck: 1 + (Meta.data.upgrades.luck * UPGRADES.luck.inc),
            powerupTime: CONFIG.POWERUP_DURATION + (Meta.data.upgrades.time * UPGRADES.time.inc),
            damage: 1 + Meta.data.upgrades.damage
        };
        
        this.boss = { 
            active: false, 
            x: this.width/2,
            y: 80,
            timer: 0, 
            hp: 100, 
            maxHp: 100,
            dir: 1,
            invulnerable: false,
            phase: 'none',
            attackTimer: 0
        };
        this.bossEventTriggered = false;
        this.bossProjectiles = [];
        
        this.lastPowerupSpawn = 0;
        
        if (Math.random() < 0.3) {
            Weather.randomWeather();
        }

        UI.showScreen('hud');
        UI.updateHUD(0, 3);
        UI.updatePowerups(this.powerups);
        UI.updateCombo(0);
        document.getElementById('boss-hp-bar').style.display = 'none';
        document.getElementById('boss-name').style.display = 'none';
        document.getElementById('boss-battle-controls').style.display = 'none';
        document.getElementById('boss-warning-text').classList.remove('anim');
        document.getElementById('blizzard-overlay').classList.remove('active');
        document.getElementById('ult-fill').style.height = '0%';
        document.getElementById('ult-btn').classList.remove('ult-ready');

        requestAnimationFrame(this.loop);
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ª—å–¥—É
    handleInputClick(x, y) {
        for (let i = this.objects.length - 1; i >= 0; i--) {
            let obj = this.objects[i];
            if (obj.type === 'FROZEN') {
                const dx = x - obj.x;
                const dy = y - obj.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 50) { // –†–∞–¥–∏—É—Å –∫–ª–∏–∫–∞
                    obj.type = 'GIFT';
                    obj.visual = obj.subType;
                    AudioSys.play('shatter');
                    this.spawnParticles(obj.x, obj.y, 10, '#a5f3fc');
                    UI.spawnFloatText("CRACK!", obj.x, obj.y, '#a5f3fc');
                    this.sessionStats.ice++;
                    Meta.updateQuest('ice', 1);
                    return;
                }
            }
        }
    }

    throwGift() {
        if (!this.bossBattleMode || this.boss.invulnerable) return;
        
        AudioSys.play('throw');
        
        this.bossProjectiles.push({
            x: this.player.x,
            y: this.height - 80,
            targetX: this.boss.x,
            targetY: this.boss.y,
            speed: 800,
            visual: 'üéÅ'
        });
    }

    activateUlt() {
        if (!this.running || this.ultCharge < 100) return;
        AudioSys.play('ult');
        this.ultCharge = 0;
        document.getElementById('ult-fill').style.height = '0%';
        document.getElementById('ult-btn').classList.remove('ult-ready');
        
        const flash = document.getElementById('flash-overlay');
        flash.style.backgroundColor = 'white';
        flash.style.opacity = 1;
        setTimeout(() => flash.style.opacity = 0, 200);

        if (this.bossBattleMode) {
            this.boss.hp -= 30;
            AudioSys.play('boss_hit');
            this.spawnParticles(this.boss.x, this.boss.y, 30, '#fbbf24');
            UI.spawnFloatText("-30 HP!", this.boss.x, this.boss.y, '#f43f5e');
            
            if (this.boss.hp <= 0) {
                this.defeatBoss();
            } else {
                this.updateBossHP();
            }
        } else {
            this.objects.forEach(o => {
                if (o.type === 'GIFT') {
                    const scoreAdd = this.powerups.double.active ? 40 : 20;
                    this.score += scoreAdd;
                    this.addCombo();
                    this.spawnParticles(o.x, o.y, 5, '#fbbf24');
                } else {
                    this.spawnParticles(o.x, o.y, 10, '#fff');
                }
            });
            this.objects = [];
        }
        
        UI.updateHUD(this.score, this.lives);
    }

    loop(t) {
        if (!this.running) return;
        const dt = (t - this.lastTime) / 1000;
        this.lastTime = t;
        this.update(dt);
        this.draw();
        requestAnimationFrame(this.loop);
    }

    update(dt) {
        this.gameTime += dt;
        
        Meta.updateQuest('time', dt);
        
        Object.keys(this.powerups).forEach(key => {
            if (this.powerups[key].active) {
                this.powerups[key].timer -= dt;
                if (this.powerups[key].timer <= 0) {
                    this.powerups[key].active = false;
                    UI.updatePowerups(this.powerups);
                }
            }
        });
        
        if (this.combo > 0 && performance.now() - this.lastCatchTime > CONFIG.COMBO_TIMEOUT * 1000) {
            this.combo = 0;
            UI.updateCombo(0);
        }
        
        // Pet logic
        if (this.pet && !this.bossBattleMode) {
            const now = Date.now();
            if (now - this.pet.lastCollect > this.pet.interval * 1000) {
                let nearestGift = null;
                let minDist = Infinity;
                
                this.objects.forEach(obj => {
                    if (obj.type === 'GIFT') {
                        const dist = Math.hypot(obj.x - this.pet.x, obj.y - this.pet.y);
                        if (dist < minDist) {
                            minDist = dist;
                            nearestGift = obj;
                        }
                    }
                });
                
                if (nearestGift && minDist < 200) {
                    this.score += 5;
                    this.sessionStats.gifts++;
                    Meta.updateQuest('gifts', 1);
                    Meta.updateQuest('score', 5);
                    this.spawnParticles(nearestGift.x, nearestGift.y, 3, '#fbbf24');
                    UI.spawnFloatText("+5 üêï", nearestGift.x, nearestGift.y - 20, '#fbbf24');
                    this.objects = this.objects.filter(o => o !== nearestGift);
                    AudioSys.play('catch');
                    this.pet.lastCollect = now;
                }
                
                this.pet.x += (this.player.x - 50 - this.pet.x) * 3 * dt;
            }
        }
        
        // Player Movement
        if (!this.bossBattleMode) {
            const speed = this.stats.speed * dt;
            let dx = 0;
            
            if (this.keys.left) { 
                this.player.x -= speed; 
                dx = -1; 
            }
            else if (this.keys.right) { 
                this.player.x += speed; 
                dx = 1; 
            }
            else if (this.input.active) {
                const diff = this.input.x - this.player.x;
                if (Math.abs(diff) > 5) { 
                    this.player.x += Math.sign(diff) * Math.min(Math.abs(diff), speed * 1.5); 
                    dx = Math.sign(diff); 
                }
            }
            
            this.player.x = Math.max(30, Math.min(this.width-30, this.player.x));
            this.player.angle += (dx * 0.3 - this.player.angle) * 10 * dt;

            this.trail.push({x:this.player.x, y:this.height-20, alpha:0.8});
            if(this.trail.length > 10) this.trail.shift();
        } else {
            const speed = this.stats.speed * dt * 0.5;
            let dx = 0;
            
            if (this.keys.left) { 
                this.player.x -= speed; 
                dx = -1; 
            }
            else if (this.keys.right) { 
                this.player.x += speed; 
                dx = 1; 
            }
            else if (this.input.active) {
                const diff = this.input.x - this.player.x;
                if (Math.abs(diff) > 5) { 
                    this.player.x += Math.sign(diff) * Math.min(Math.abs(diff), speed); 
                    dx = Math.sign(diff); 
                }
            }
            
            this.player.x = Math.max(30, Math.min(this.width-30, this.player.x));
            this.player.angle += (dx * 0.3 - this.player.angle) * 10 * dt;
        }

        // Boss Logic
        if (!this.bossEventTriggered && this.gameTime > CONFIG.BOSS_TIME) {
            this.startBossEvent();
        }
        
        if (this.boss.active && this.boss.phase === 'flying') {
            this.boss.timer -= dt;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –±–æ—Å—Å–∞
            this.boss.x += 150 * this.boss.dir * dt;
            if (this.boss.x < 100 || this.boss.x > this.width - 100) {
                this.boss.dir *= -1;
                this.boss.x = Math.max(100, Math.min(this.width - 100, this.boss.x));
            }
            
            this.boss.y = 80;

            if (this.boss.timer <= 0) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –±–∏—Ç–≤–æ–π —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∞–≥–∞
                setTimeout(() => {
                    if (this.running) {
                        this.startBossBattle();
                    }
                }, 100);
            }
        }
        
        if (this.bossBattleMode && this.boss.phase === 'battle') {
            this.updateBossBattle(dt);
        }

        // Spawning
        if (!this.bossBattleMode) {
            this.handleSpawning(dt);
        }

        // Objects Update
        const speedMult = this.powerups.slow.active ? 0.5 : 1;
        for (let i = this.objects.length - 1; i >= 0; i--) {
            let obj = this.objects[i];
            obj.y += obj.speed * speedMult * dt;
            obj.angle += obj.rot * dt;

            if (obj.type === 'GIFT' && this.powerups.magnet.active && obj.y > this.height/2) {
                const magnetRadius = 100 + (this.stats.magnetLevel * 50);
                const dist = Math.abs(this.player.x - obj.x);
                if (dist < magnetRadius) {
                    obj.x += (this.player.x - obj.x) * 5 * dt;
                }
            }

            if (obj.y > this.height) {
                this.objects.splice(i, 1);
                if (obj.type === 'GIFT') {
                    this.combo = 0;
                    UI.updateCombo(0);
                }
                continue;
            }

            if (Math.abs(obj.x - this.player.x) < 40 && Math.abs(obj.y - (this.height - 40)) < 40) {
                this.handleCollision(obj);
                this.objects.splice(i, 1);
            }
        }
        
        // Boss Projectiles Update
        for (let i = this.bossProjectiles.length - 1; i >= 0; i--) {
            let proj = this.bossProjectiles[i];
            const dx = proj.targetX - proj.x;
            const dy = proj.targetY - proj.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist < 10) {
                this.boss.hp -= this.stats.damage;
                AudioSys.play('boss_hit');
                this.spawnParticles(proj.targetX, proj.targetY, 10, '#fbbf24');
                UI.spawnFloatText(`-${this.stats.damage}`, proj.targetX, proj.targetY, '#f43f5e');
                this.bossProjectiles.splice(i, 1);
                
                if (this.boss.hp <= 0) {
                    this.defeatBoss();
                } else {
                    this.updateBossHP();
                }
            } else {
                proj.x += (dx / dist) * proj.speed * dt;
                proj.y += (dy / dist) * proj.speed * dt;
            }
        }

        // Particles
        this.particles.forEach(p => { 
            p.x+=p.vx*dt; 
            p.y+=p.vy*dt; 
            p.vy+=500*dt; 
            p.life-=dt; 
        });
        this.particles = this.particles.filter(p => p.life > 0);
        
        // Ultimate charge display
        const fill = document.getElementById('ult-fill');
        if (fill.style.height !== this.ultCharge+'%') {
            fill.style.height = this.ultCharge + '%';
            if (this.ultCharge >= 100) {
                document.getElementById('ult-btn').classList.add('ult-ready');
            }
        }
        
        UI.updatePowerups(this.powerups);
    }

    startBossEvent() {
        this.bossEventTriggered = true;
        this.boss.active = true;
        this.boss.phase = 'flying';
        this.boss.timer = 10;
        this.boss.x = this.width / 2;
        this.boss.y = 80;
        this.boss.dir = 1;
        
        AudioSys.play('boss_start');
        
        const warning = document.getElementById('boss-warning-text');
        warning.classList.remove('anim');
        void warning.offsetWidth;
        warning.classList.add('anim');
        
        document.getElementById('blizzard-overlay').classList.add('active');
        Weather.start('blizzard');
    }

    startBossBattle() {
        this.bossBattleMode = true;
        this.boss.phase = 'battle';
        this.objects = [];
        
        this.boss.hp = this.boss.maxHp = 100;
        this.boss.y = 100;
        this.boss.x = this.width / 2;
        this.boss.invulnerable = false;
        this.boss.attackTimer = 0;
        
        document.getElementById('boss-hp-bar').style.display = 'block';
        document.getElementById('boss-name').style.display = 'block';
        document.getElementById('boss-battle-controls').style.display = 'flex';
        document.getElementById('blizzard-overlay').classList.add('active');
        
        this.updateBossHP();
    }

    updateBossBattle(dt) {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –±–æ—Å—Å–∞ –≤ –±–∏—Ç–≤–µ
        this.boss.x += Math.sin(this.gameTime * 1.5) * 100 * dt;
        this.boss.x = Math.max(100, Math.min(this.width - 100, this.boss.x));
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–æ—Å—Å —Å—Ç—Ä–µ–ª—è–µ—Ç –ø–æ –∏–≥—Ä–æ–∫—É
        this.boss.attackTimer += dt;
        if (this.boss.attackTimer >= 1.5) {
            this.boss.attackTimer = 0;
            
            // –°—Ç—Ä–µ–ª—è–µ–º –≤ —Å—Ç–æ—Ä–æ–Ω—É –∏–≥—Ä–æ–∫–∞
            const angle = Math.atan2((this.height - 80) - this.boss.y, this.player.x - this.boss.x);
            
            this.objects.push({
                x: this.boss.x,
                y: this.boss.y + 40,
                type: 'BAD',
                visual: ASSETS.BOSS_PROJ,
                speed: 350,
                angle: 0,
                rot: 0,
                vx: Math.cos(angle) * 200,
                vy: Math.sin(angle) * 200
            });
        }
    }

    updateBossHP() {
        const pct = (this.boss.hp / this.boss.maxHp) * 100;
        document.getElementById('boss-hp-fill').style.width = pct + '%';
    }

    defeatBoss() {
        this.bossBattleMode = false;
        this.boss.active = false;
        this.boss.phase = 'none';
        this.boss.invulnerable = true;
        
        document.getElementById('boss-hp-bar').style.display = 'none';
        document.getElementById('boss-name').style.display = 'none';
        document.getElementById('boss-battle-controls').style.display = 'none';
        document.getElementById('blizzard-overlay').classList.remove('active');
        Weather.stop();
        
        UI.spawnFloatText("+500 –ü–û–ë–ï–î–ê!", this.width/2, 200, '#fbbf24');
        AudioSys.play('win');
        this.score += 500;
        this.sessionStats.bosses++;
        Meta.updateQuest('boss', 1);
        UI.updateHUD(this.score, this.lives);
        this.spawnParticles(this.width/2, 200, 50, '#fbbf24');
        
        Weather.start('fireworks');
        setTimeout(() => Weather.stop(), 5000);
    }

    handleSpawning(dt) {
        let spawnRate = (this.boss.active && this.boss.phase === 'flying') ? 0.3 : Math.max(0.4, 0.8 - this.gameTime * 0.005);
        
        if (Math.random() < dt / spawnRate) {
            let type, visual, speed = 300, subType = null;

            if (this.boss.active && this.boss.phase === 'flying') {
                type = 'BAD';
                visual = ASSETS.BOSS_PROJ;
                speed = 450;
                this.objects.push({ 
                    x: this.boss.x, 
                    y: this.boss.y + 40, 
                    type, 
                    visual, 
                    speed, 
                    angle:0, 
                    rot:5 
                });
            } else {
                const r = Math.random() * this.stats.luck;
                if (r < 0.1) {
                    type = 'FROZEN';
                    visual = ASSETS.ICE;
                    subType = ASSETS.GIFTS[Math.floor(Math.random()*ASSETS.GIFTS.length)];
                    speed = 350;
                } else if (r < 0.3) {
                    type = 'BAD';
                    visual = ASSETS.BAD[Math.floor(Math.random()*ASSETS.BAD.length)];
                } else {
                    type = 'GIFT';
                    visual = ASSETS.GIFTS[Math.floor(Math.random()*ASSETS.GIFTS.length)];
                }
                this.objects.push({ 
                    x: Math.random() * (this.width - 40) + 20, 
                    y: -50, type, visual, subType, speed, angle:0, rot: (Math.random()-0.5)*2 
                });
            }
        }
        
        this.lastPowerupSpawn += dt;
        if (this.lastPowerupSpawn > 10 + Math.random() * 5) {
            this.lastPowerupSpawn = 0;
            
            const powerupTypes = ['shield', 'magnet', 'double', 'slow'];
            const randomPowerup = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
            const powerupData = ASSETS.POWERUPS[randomPowerup];
            
            this.objects.push({
                x: Math.random() * (this.width - 40) + 20,
                y: -50,
                type: 'POWERUP',
                powerupType: randomPowerup,
                visual: powerupData.icon,
                speed: 250,
                angle: 0,
                rot: 0
            });
        }
    }

    addCombo() {
        this.combo++;
        if (this.combo > this.maxCombo) {
            this.maxCombo = this.combo;
            Meta.updateQuest('combo', this.combo);
        }
        this.lastCatchTime = performance.now();
        UI.updateCombo(this.combo);
    }

    handleCollision(obj) {
        if (obj.type === 'GIFT') {
            AudioSys.play('catch');
            
            let scoreAdd = 10;
            if (this.powerups.double.active) scoreAdd *= 2;
            if (this.combo >= 3) scoreAdd *= 1.5;
            if (this.combo >= 5) scoreAdd *= 2;
            
            scoreAdd = Math.floor(scoreAdd);
            
            this.score += scoreAdd;
            this.sessionStats.gifts++;
            this.addCombo();
            this.ultCharge = Math.min(100, this.ultCharge + 10);
            this.spawnParticles(obj.x, obj.y, 5, '#fbbf24');
            UI.spawnFloatText(`+${scoreAdd}`, obj.x, obj.y - 20, '#fbbf24');
            
            Meta.updateQuest('gifts', 1);
            Meta.updateQuest('score', scoreAdd);
            
        } else if (obj.type === 'POWERUP') {
            AudioSys.play('powerup');
            const powerupType = obj.powerupType;
            this.powerups[powerupType].active = true;
            this.powerups[powerupType].timer = this.stats.powerupTime;
            
            const powerupData = ASSETS.POWERUPS[powerupType];
            this.spawnParticles(obj.x, obj.y, 10, powerupData.color);
            UI.spawnFloatText(powerupData.name + "!", obj.x, obj.y - 20, powerupData.color);
            UI.updatePowerups(this.powerups);
            
            this.sessionStats.powerups++;
            Meta.updateQuest('powerups', 1);
            
        } else if (obj.type === 'BAD' || obj.type === 'FROZEN') {
            if (this.powerups.shield.active) {
                AudioSys.play('shatter');
                this.powerups.shield.active = false;
                UI.spawnFloatText("–ó–ê–©–ò–¢–ê!", obj.x, obj.y, '#3b82f6');
                this.spawnParticles(obj.x, obj.y, 15, '#3b82f6');
                UI.updatePowerups(this.powerups);
            } else {
                AudioSys.play('hit');
                this.lives--;
                this.damageTaken++;
                this.combo = 0;
                UI.updateCombo(0);
                this.triggerFlash('rgba(244, 63, 94, 0.5)');
                this.screenShake();
                UI.spawnFloatText(obj.type==='FROZEN'?"–õ–Å–î!":"–û–ô!", obj.x, obj.y, '#f43f5e');
                if (this.lives <= 0) this.gameOver();
            }
        }
        UI.updateHUD(this.score, this.lives);
    }

    spawnParticles(x, y, count, color) {
        for(let i=0; i<count; i++) {
            this.particles.push({
                x, y, 
                vx:(Math.random()-0.5)*400, 
                vy:(Math.random()-0.5)*400, 
                life:0.5, 
                color
            });
        }
    }

    triggerFlash(color) {
        const el = document.getElementById('flash-overlay');
        el.style.backgroundColor = color; 
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 100);
    }

    screenShake() {
        this.canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
        setTimeout(() => this.canvas.style.transform = 'none', 200);
    }

    draw() {
        this.ctx.clearRect(0, 0, this.width, this.height);

        // Trail
        this.trail.forEach(t => {
            t.alpha -= 0.08; 
            t.y += 2;
            if(t.alpha>0) { 
                this.ctx.fillStyle = `rgba(255,255,255,${t.alpha})`; 
                this.ctx.beginPath(); 
                this.ctx.arc(t.x, t.y, 3, 0, Math.PI*2); 
                this.ctx.fill(); 
            }
        });

        // Player
        this.ctx.save();
        this.ctx.translate(this.player.x, this.height - 20);
        this.ctx.rotate(this.player.angle);
        
        if (this.powerups.shield.active) {
            this.ctx.strokeStyle = '#3b82f6';
            this.ctx.lineWidth = 3;
            this.ctx.shadowBlur = 15;
            this.ctx.shadowColor = '#3b82f6';
            this.ctx.beginPath();
            this.ctx.arc(0, -10, 40, 0, Math.PI * 2);
            this.ctx.stroke();
        }
        
        this.ctx.font = "60px Arial"; 
        this.ctx.textAlign = "center"; 
        this.ctx.textBaseline = "bottom";
        this.ctx.shadowBlur = 0;
        this.ctx.fillText(this.player.skin, 0, 0);
        this.ctx.restore();
        
        // Pet
        if (this.pet) {
            this.ctx.font = "40px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(PETS.lexi.icon, this.pet.x, this.pet.y);
        }

        // Boss
        if (this.boss.active && (this.boss.phase === 'flying' || this.boss.phase === 'battle')) {
            this.ctx.font = "80px Arial"; 
            this.ctx.textAlign = "center";
            
            let offsetX = 0, offsetY = 0;
            if (this.boss.hp < this.boss.maxHp * 0.3) {
                offsetX = Math.sin(Date.now() * 0.05) * 3;
                offsetY = Math.sin(Date.now() * 0.08) * 3;
            }
            
            this.ctx.fillText(ASSETS.BOSS, this.boss.x + offsetX, this.boss.y + offsetY);
        }

        // Objects
        this.ctx.textAlign = "center"; 
        this.ctx.textBaseline = "middle";
        this.objects.forEach(o => {
            this.ctx.save();
            this.ctx.translate(o.x, o.y);
            this.ctx.rotate(o.angle);
            
            if (o.type === 'POWERUP') {
                const powerupData = ASSETS.POWERUPS[o.powerupType];
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = powerupData.color;
            }
            
            this.ctx.font = "40px Arial";
            this.ctx.fillText(o.visual, 0, 0);
            this.ctx.restore();
        });
        
        // Boss Projectiles
        this.ctx.shadowBlur = 0;
        this.bossProjectiles.forEach(p => {
            this.ctx.font = "30px Arial";
            this.ctx.fillText(p.visual, p.x, p.y);
        });

        // Particles
        this.particles.forEach(p => { 
            this.ctx.fillStyle=p.color; 
            this.ctx.globalAlpha=p.life/0.5; 
            this.ctx.fillRect(p.x, p.y, 4, 4); 
        });
        this.ctx.globalAlpha = 1;
    }

    gameOver() {
        this.running = false;
        Weather.stop();
        
        Meta.data.stats.totalGifts += this.sessionStats.gifts;
        Meta.data.stats.totalBosses += this.sessionStats.bosses;
        Meta.data.stats.gamesPlayed++;
        if (this.gameTime > Meta.data.stats.maxTime) {
            Meta.data.stats.maxTime = Math.floor(this.gameTime);
        }
        if (this.maxCombo > Meta.data.stats.maxCombo) {
            Meta.data.stats.maxCombo = this.maxCombo;
        }
        if (this.damageTaken === 0 && this.gameTime > 10) {
            Meta.data.stats.noDamageGames++;
        }
        
        let questRewards = 0;
        let completedQuestMessages = [];
        Meta.data.quests.forEach(quest => {
            if (quest.completed) {
                const template = QUEST_TEMPLATES.find(t => t.id === quest.id);
                if (template && !quest.rewardClaimed) {
                    questRewards += template.reward;
                    completedQuestMessages.push(`‚úÖ ${template.desc} (+${template.reward} üü°)`);
                    quest.rewardClaimed = true;
                }
            }
        });
        
        const newAchievements = Meta.checkAchievements();
        let achievementRewards = 0;
        let achievementMessages = [];
        
        newAchievements.forEach(ach => {
            achievementRewards += ach.reward;
            achievementMessages.push(`üèÜ ${ach.name} (+${ach.reward} üü°)`);
        });
        
        const earned = Math.floor(this.score / 2) + questRewards + achievementRewards;
        Meta.addScore(this.score);
        Meta.data.wallet += earned;
        Meta.updateLeaderboard(this.score);
        Meta.save();
        
        document.getElementById('go-score').innerText = this.score;
        document.getElementById('go-combo').innerText = 'x' + this.maxCombo;
        document.getElementById('go-earned').innerText = `+${earned} üü°`;
        
        const questMsg = document.getElementById('quest-complete-msg');
        if (completedQuestMessages.length > 0) {
            questMsg.style.display = 'block';
            questMsg.innerHTML = completedQuestMessages.join('<br>');
        } else {
            questMsg.style.display = 'none';
        }
        
        const achMsg = document.getElementById('achievement-unlock-msg');
        if (achievementMessages.length > 0) {
            achMsg.style.display = 'block';
            achMsg.innerHTML = achievementMessages.join('<br>');
        } else {
            achMsg.style.display = 'none';
        }
        
        UI.openModal('game-over-modal');
    }
}

/* ============================================
   UI MANAGER
   ============================================ */
const UI = {
    currentTab: 'upgrades',
    
    init() { 
        setInterval(() => this.updateTimer(), 1000); 
        this.updateMenu();
        this.renderContent();
    },
    
    updateMenu() {
        document.getElementById('menu-attempts').innerText = `${Meta.data.attempts}/4`;
        document.getElementById('menu-wallet').innerText = Math.floor(Meta.data.wallet);
        document.getElementById('menu-best').innerText = Meta.data.bestScore;
        document.getElementById('ui-idle-bank').innerText = Math.floor(Meta.data.idleBank);
        
        const totalElves = Meta.data.factory.elf + Meta.data.factory.machine;
        const income = (Meta.data.factory.elf * FACTORY.elf.income) + 
                       (Meta.data.factory.machine * FACTORY.machine.income);
        document.getElementById('ui-elves-count').innerText = totalElves;
        document.getElementById('ui-idle-rate').innerText = income.toFixed(1);
    },
    
    updateHUD(score, lives) {
        document.getElementById('hud-score').innerText = Math.floor(score);
        document.getElementById('hud-hearts').innerText = "‚ù§Ô∏è".repeat(Math.max(0,lives));
    },
    
    updateCombo(combo) {
        const display = document.getElementById('combo-display');
        const mult = document.getElementById('combo-mult');
        
        if (combo >= 3) {
            display.classList.add('show');
            mult.innerText = combo;
        } else {
            display.classList.remove('show');
        }
    },
    
    updatePowerups(powerups) {
        const container = document.getElementById('powerups-display');
        container.innerHTML = '';
        
        Object.keys(powerups).forEach(key => {
            if (powerups[key].active) {
                const data = ASSETS.POWERUPS[key];
                const div = document.createElement('div');
                div.className = `powerup-indicator ${key}`;
                div.innerHTML = `<span>${data.icon}</span><span>${Math.ceil(powerups[key].timer)}s</span>`;
                container.appendChild(div);
            }
        });
    },
    
    updateTimer() {
        Meta.checkRefill();
        const diff = Meta.data.nextRefill - Date.now();
        const el2 = document.getElementById('modal-timer');
        
        if (Meta.data.attempts >= 4) return;
        if (diff > 0) {
            const t = new Date(diff).toISOString().substr(11, 8);
            el2.innerText = t;
        }
    },
    
    switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('#menu-screen .tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        this.renderContent();
    },
    
    renderContent() {
        const grid = document.getElementById('grid-content');
        grid.innerHTML = '';

        if (this.currentTab === 'upgrades') {
            Object.keys(UPGRADES).forEach(key => {
                const u = UPGRADES[key];
                const lvl = Meta.data.upgrades[key];
                const cost = Math.floor(u.cost * Math.pow(1.5, lvl));
                const isMax = lvl >= u.max;
                const canAfford = Meta.data.wallet >= cost;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${u.name} <span class="lvl-badge">LVL ${lvl}/${u.max}</span></h3>
                    <div class="icon">${u.icon}</div>
                    <div style="font-size:0.8rem; color:#888">${u.desc}</div>
                    <button class="btn" ${isMax || !canAfford ? 'disabled' : ''} 
                        onclick="Meta.buyUpgrade('${key}')">
                        ${isMax ? 'MAX' : cost + ' üü°'}
                    </button>
                `;
                grid.appendChild(card);
            });
        } else if (this.currentTab === 'skins') {
            Object.keys(SKINS).forEach(key => {
                const s = SKINS[key];
                const owned = Meta.data.skins.includes(key);
                const equipped = Meta.data.currentSkin === key;
                const canAfford = Meta.data.wallet >= s.cost;
                
                const card = document.createElement('div');
                card.className = 'card';
                if(equipped) card.style.borderColor = 'var(--gold)';
                card.innerHTML = `
                    <h3>${s.name}</h3>
                    <div class="icon">${s.icon}</div>
                    <button class="btn ${equipped ? 'green' : ''}" 
                        ${!owned && !canAfford ? 'disabled' : ''} 
                        onclick="Meta.buySkin('${key}')">
                        ${equipped ? '–í–´–ë–†–ê–ù–û' : (owned ? '–í–´–ë–†–ê–¢–¨' : s.cost + ' üü°')}
                    </button>
                `;
                grid.appendChild(card);
            });
        } else if (this.currentTab === 'factory') {
            Object.keys(FACTORY).forEach(key => {
                const f = FACTORY[key];
                const count = Meta.data.factory[key];
                const cost = Math.floor(f.baseCost * Math.pow(1.2, count));
                const canAfford = Meta.data.wallet >= cost;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${f.name} <span class="lvl-badge">x${count}</span></h3>
                    <div class="icon">${f.icon}</div>
                                        <div style="font-size:0.8rem; color:#22c55e">+${f.income}/—Å–µ–∫</div>
                    <button class="btn" ${!canAfford ? 'disabled' : ''} 
                        onclick="Meta.buyFactory('${key}')">
                        ${cost} üü°
                    </button>
                `;
                grid.appendChild(card);
            });
        } else if (this.currentTab === 'pets') {
            Object.keys(PETS).forEach(key => {
                const pet = PETS[key];
                const owned = Meta.data.pets[key];
                const level = owned ? owned.level : 0;
                const isMax = level >= pet.maxLevel;
                const cost = owned ? Math.floor(pet.cost * Math.pow(1.5, level)) : pet.cost;
                const canAfford = Meta.data.wallet >= cost;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.position = 'relative';
                if (!owned) card.classList.add('locked');
                card.innerHTML = `
                    <h3>${pet.name} ${owned ? `<span class="lvl-badge">LVL ${level}/${pet.maxLevel}</span>` : ''}</h3>
                    <div class="icon">${pet.icon}</div>
                    <div style="font-size:0.8rem; color:#888">${pet.desc}</div>
                    ${owned ? `<div style="font-size:0.7rem; color:#22c55e; margin-top:5px;">–ò–Ω—Ç–µ—Ä–≤–∞–ª: ${(pet.baseInterval - level * 0.5).toFixed(1)}—Å</div>` : ''}
                    <button class="btn" ${(isMax || !canAfford) ? 'disabled' : ''} 
                        onclick="Meta.buyPet('${key}')">
                        ${isMax ? 'MAX' : (owned ? '–£–õ–£–ß–®–ò–¢–¨ ' : '–ö–£–ü–ò–¢–¨ ') + cost + ' üü°'}
                    </button>
                `;
                grid.appendChild(card);
            });
        } else if (this.currentTab === 'achievements') {
            ACHIEVEMENTS.forEach(ach => {
                const unlocked = Meta.data.achievements.includes(ach.id);
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.gridColumn = 'span 2';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                        <div class="icon" style="font-size: 3rem;">${ach.icon}</div>
                        <div style="flex: 1; text-align: left;">
                            <h3 style="margin: 0;">${ach.name} ${unlocked ? '‚úÖ' : 'üîí'}</h3>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">${ach.desc}</div>
                            <div style="font-size: 0.9rem; color: var(--gold); margin-top: 5px; font-weight: bold;">
                                –ù–∞–≥—Ä–∞–¥–∞: ${ach.reward} üü°
                            </div>
                        </div>
                    </div>
                `;
                if (!unlocked) card.style.opacity = '0.5';
                grid.appendChild(card);
            });
        }
        this.updateMenu();
    },
    
    renderQuests() {
        const list = document.getElementById('quest-list');
        list.innerHTML = '';
        
        Meta.data.quests.forEach(quest => {
            const template = QUEST_TEMPLATES.find(t => t.id === quest.id);
            if (!template) return;
            
            const progress = Math.min(quest.progress, template.target);
            const percent = (progress / template.target) * 100;
            
            const div = document.createElement('div');
            div.className = `quest-item ${quest.completed ? 'completed' : ''}`;
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold;">${template.desc}</div>
                        <div style="font-size: 0.8rem; color: #888;">
                            ${Math.floor(progress)} / ${template.target}
                        </div>
                    </div>
                    <div style="color: var(--gold); font-weight: bold;">
                        ${quest.completed ? '‚úÖ' : template.reward + ' üü°'}
                    </div>
                </div>
                <div class="quest-progress-bar">
                    <div class="quest-progress-fill" style="width: ${percent}%"></div>
                </div>
            `;
            list.appendChild(div);
        });
    },
    
    renderLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';
        
        const sorted = [...Meta.data.leaderboard].sort((a, b) => b.score - a.score).slice(0, 10);
        
        if (sorted.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
        } else {
            sorted.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'first';
                else if (index === 1) rankClass = 'second';
                else if (index === 2) rankClass = 'third';
                
                div.innerHTML = `
                    <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                    <div style="flex: 1;">${entry.name}</div>
                    <div style="font-weight: bold; color: var(--gold);">${entry.score}</div>
                `;
                list.appendChild(div);
            });
        }
        
        const yourRank = sorted.findIndex(e => e.score === Meta.data.bestScore) + 1;
        document.getElementById('your-rank').innerText = yourRank > 0 ? `#${yourRank}` : '-';
    },
    
    spawnFloatText(text, x, y, color) {
        const el = document.createElement('div');
        el.className = 'float-text'; 
        el.innerText = text;
        el.style.left = x+'px'; 
        el.style.top = y+'px'; 
        el.style.color = color||'#fff';
        document.getElementById('game-container').appendChild(el);
        setTimeout(()=>el.remove(), 1000);
    },
    
    showScreen(id) {
        document.querySelectorAll('.ui-layer').forEach(e => {
            e.classList.add('hidden');
        });
        
        const target = document.getElementById(id+'-screen');
        if(target) {
            target.classList.remove('hidden');
        }
    },
    
    openModal(id) { 
        this.closeAllModals();
        if (id === 'quest-modal') {
            this.renderQuests();
        } else if (id === 'leaderboard-modal') {
            this.renderLeaderboard();
        }
        document.getElementById(id).classList.add('open'); 
    },
    
    closeAllModals() { 
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); 
    }
};

/* ============================================
   GAME CONTROLLER
   ============================================ */
const Game = {
    engine: new GameEngine(),
    
    startRequest() {
        if (Meta.useAttempt()) { 
            UI.showScreen('hud'); 
            UI.updateMenu(); 
            this.engine.start(); 
        } else { 
            UI.openModal('no-lives-modal'); 
        }
    },
    
    returnToMenu() { 
        UI.closeAllModals(); 
        UI.showScreen('menu'); 
        UI.updateMenu(); 
        UI.renderContent();
    },
    
    activateUlt() { 
        this.engine.activateUlt(); 
    },
    
    throwGift() {
        this.engine.throwGift();
    }
};

/* ============================================
   INITIALIZATION
   ============================================ */
window.onload = () => { 
    Meta.init(); 
    UI.init();
    LoadingSystem.start();
};
</script>
</body>
</html>
